/**
 * ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–´–ô —Ö—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram SDK —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
 */

import { useCallback } from 'react';

export interface SafeLaunchParams {
  launchParams: any | null;
  error: string | null;
  isAvailable: boolean;
}

/**
 * ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π wrapper –¥–ª—è useLaunchParams —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
 * –í–ê–ñ–ù–û: –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç useLaunchParams –Ω–∞–ø—Ä—è–º—É—é, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
 */
export function useSafeLaunchParams(): SafeLaunchParams {
  try {
    // ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º useLaunchParams —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ
    const { useLaunchParams } = require('@telegram-apps/sdk-react');
    
    // ‚úÖ –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å launch params
    const launchParams = useLaunchParams(true);
    
    return {
      launchParams,
      error: null,
      isAvailable: true
    };
  } catch (error) {
    // ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É LaunchParamsRetrieveError
    console.log('‚ÑπÔ∏è LaunchParams –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞):', error);
    
    return {
      launchParams: null,
      error: error instanceof Error ? error.message : 'Unknown error',
      isAvailable: false
    };
  }
}

/**
 * ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ä–µ–¥—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ SDK
 */
export function useSafeEnvironmentDetection() {
  const { launchParams, isAvailable } = useSafeLaunchParams();
  
  const detectEnvironment = useCallback(() => {
    if (typeof window === 'undefined') return 'browser';
    
    const ua = navigator.userAgent;
    const searchParams = new URLSearchParams(window.location.search);
    const pathname = window.location.pathname;
    
    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp API
    const hasTelegramWebApp = !!(window as any)?.Telegram?.WebApp;
    const webApp = (window as any)?.Telegram?.WebApp;
    
    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Mini App –î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–û –≥–æ—Ç–æ–≤
    const isRealMiniApp = hasTelegramWebApp && 
                         webApp && 
                         webApp.initData && 
                         webApp.version &&
                         typeof webApp.ready === 'function';
    
    // ‚úÖ –í–ê–ñ–ù–û: –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ redirect –ù–ï –º–æ–∂–µ—Ç –±—ã—Ç—å Mini App
    const isRedirectPage = pathname === '/tg-redirect';
    
    console.log('üîç Safe Environment Detection:', {
      userAgent: ua.substring(0, 60) + '...',
      pathname,
      isRedirectPage,
      hasTelegramWebApp,
      isRealMiniApp,
      launchParamsAvailable: isAvailable,
      webAppVersion: webApp?.version,
      webAppInitData: !!webApp?.initData
    });
    
    // ‚úÖ –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ - —Ç–æ–ª—å–∫–æ –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ telegram-web
    if (isRedirectPage) {
      console.log('üö® Redirect page - –ù–ï Mini App');
      
      const isTelegramBrowser = 
        ua.includes('TelegramBot') || 
        ua.includes('Telegram/') ||
        ua.includes('tgWebApp') ||
        ua.includes('TgWebView') ||
        searchParams.has('tgWebAppData') ||
        searchParams.has('tgWebAppVersion');
      
      return isTelegramBrowser ? 'telegram-web' : 'browser';
    }
    
    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–π Mini App
    if (isRealMiniApp && isAvailable) {
      return 'mini-app';
    }
    
    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram –±—Ä–∞—É–∑–µ—Ä (–±–µ–∑ launch params)
    const isTelegramBrowser = 
      ua.includes('TelegramBot') || 
      ua.includes('Telegram/') ||
      ua.includes('tgWebApp') ||
      hasTelegramWebApp; // WebApp API –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ launch params
    
    if (isTelegramBrowser) {
      return 'telegram-web';
    }
    
    return 'browser';
  }, [launchParams, isAvailable]);
  
  return {
    launchParams,
    detectEnvironment,
    isLaunchParamsAvailable: isAvailable
  };
}
